#
# Copyright (c) 2021-present, Trail of Bits, Inc.
# All rights reserved.
#
# This source code is licensed in accordance with the terms specified in
# the LICENSE file found in the root directory of this source tree.
#

name: Build

on:
  push:
    branches:
      - 'master'

    tags:
      - '*'

  pull_request:
    branches:
      - '*'

env:
  # Indicates the location of the vcpkg as a Git submodule of the project repository.
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  # Tells vcpkg where binary packages are stored.
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg/bincache
  # Use specific vcpkg version
  VCPKG_COMMIT_ID: '9836ae4f2671db41e07843f31b4e341f0d3ebfb1'
  # Setup compiler
  CC: clang-12
  CXX: clang++-12

jobs:
  build_linux:
    strategy:
      fail-fast: false
      matrix:
        image:
          - { name: 'ubuntu', tag: '20.04' }

        llvm: [ '14' ]
        cxxcommon_version: [ 'v0.2.2' ]

    runs-on: ubuntu-20.04

    timeout-minutes: 15

    container:
      image: docker.pkg.github.com/lifting-bits/cxx-common/vcpkg-builder-${{ matrix.image.name }}:${{ matrix.image.tag }}

      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
    # setup environment
    - name: "Create directory '${{ env.VCPKG_DEFAULT_BINARY_CACHE }}'"
      run: mkdir -p $VCPKG_DEFAULT_BINARY_CACHE
      shell: bash

    - name: Install dependencies
      shell: bash
      run: |
        apt-get update
        apt-get install --yes --no-install-recommends \
          clang-12 build-essential ninja-build ccache libstdc++-10-dev

        update-alternatives \
            --install /usr/bin/clang clang /usr/bin/clang-12 10 \
            --slave   /usr/bin/clang++ clang++ /usr/bin/clang++-12

    - name: Setup paths
      shell: bash
      id: paths
      run: |
        mkdir -p build src install ccache
        echo ::set-output name=src::$(pwd)/src
        echo ::set-output name=build::$(pwd)/build
        echo ::set-output name=install::$(pwd)/install
        echo ::set-output name=ccache::$(pwd)/ccache

    - name: Get latest CMake and ninja
      uses: xlauko/get-cmake@main

    # setup cxx-common
    - name: Download cxx-common
      id: cxxcommon
      uses: lifting-bits/download-cxx-common@v1
      with:
        llvm: ${{ matrix.llvm }}
        version: ${{ matrix.cxxcommon_version }}
        token: ${{ secrets.GITHUB_TOKEN }}
        image: ${{ matrix.image.name }}
        image_tag: ${{ matrix.image.tag }}
        destination: ${{ steps.paths.outputs.install }}

    # TODO(Heno) temporary download cxx-common ports
    - name: Clone the cxx-common ports
      id: cxx-common-ports
      uses: actions/checkout@v3
      with:
        repository: 'lifting-bits/cxx-common'
        path: ${{ steps.paths.outputs.src }}/cxx-common-ports
        ref: 'port-files'
        fetch-depth: 1

    - name: Clone the vcpkg for cxx-common
      id: cxx-common-ports-vcpkg
      uses: actions/checkout@v3
      with:
        repository: 'microsoft/vcpkg'
        path: ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg
        fetch-depth: 1

    - name: Setup vcpkg
      working-directory: ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg
      run: |
        export CMAKE_C_COMPILER_LAUNCHER="$(which ccache)"
        export CMAKE_CXX_COMPILER_LAUNCHER="$(which ccache)"

        ./bootstrap-vcpkg.sh
        ./vcpkg integrate install

    # setup circuitous
    - name: Clone the circuitous repository
      uses: actions/checkout@v3
      with:
        path: ${{ steps.paths.outputs.src }}/circuitous
        submodules: true
        fetch-depth: 1

    - name: Install circuitous python requirements
      working-directory: ${{ steps.paths.outputs.src }}/circuitous
      shell: bash
      run: |
          pip install --no-cache-dir -r requirements.txt

    - name: Configure circuitous
      working-directory: ${{ steps.paths.outputs.src }}/circuitous
      env:
        # TODO(Heno): use ports from cxx-common
        VCPKG_ROOT: ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg
        CXX_COMMON_ROOT: ${{ steps.paths.outputs.src }}/cxx-common-ports
        CMAKE_PREFIX_PATH: ${{ steps.paths.outputs.install }}/vcpkg_ubuntu-20.04_llvm-14_amd64/installed/x64-linux-rel/share/:${CMAKE_PREFIX_PATH}
        BUILD_DIR: ${{ steps.paths.outputs.build }}/circuitous/
      shell: bash
      run: |
        # TODO(Heno): fix in port patch
        mkdir -p ./vcpkg_installed/x64-linux-rel
        mkdir -p ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg/installed/x64-linux-rel
        cmake --preset ninja-cxx-common-system-llvm-x64-linux-rel -B ${{ steps.paths.outputs.build }}/circuitous -DCMAKE_VERBOSE_MAKEFILE=true || true

    - name: Build circuitous
      working-directory: ${{ steps.paths.outputs.build }}/circuitous
      env:
        CCACHE_DIR: ${{ steps.paths.outputs.ccache }}
      run: |
        # TODO(Heno): use preset
        cmake --build ${{ steps.paths.outputs.build }}/circuitous -j $(nproc)

    - name: Install circuitous
      working-directory: ${{ steps.paths.outputs.build }}/circuitous
      env:
        CCACHE_DIR: ${{ steps.paths.outputs.ccache }}
      run: |
        cmake --build ${{ steps.paths.outputs.build }}/circuitous --target install

    - name: Run circuitous unittests
      working-directory: ${{ steps.paths.outputs.build }}/circuitous
      run: |
        ctest
