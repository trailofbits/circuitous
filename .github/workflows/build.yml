#
# Copyright (c) 2021-present, Trail of Bits, Inc.
# All rights reserved.
#
# This source code is licensed in accordance with the terms specified in
# the LICENSE file found in the root directory of this source tree.
#

name: Build

on:
  push:
    branches:
      - 'master'

    tags:
      - '*'

  pull_request:
    branches:
      - '*'

env:
  # Tells vcpkg where binary packages are stored.
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg/bincache

jobs:
  build_linux:
    strategy:
      fail-fast: false
      matrix:
        image:
          - { name: 'ubuntu', tag: '20.04' }

        llvm: [ '14' ]
        cxxcommon_version: [ 'v0.2.9' ]

    runs-on: ubuntu-22.04

    timeout-minutes: 15

    steps:
    # setup environment
    - name: "Create directory '${{ env.VCPKG_DEFAULT_BINARY_CACHE }}'"
      run: mkdir -p $VCPKG_DEFAULT_BINARY_CACHE
      shell: bash

    - name: Install dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install --yes --no-install-recommends \
          ninja-build clang-tidy cppcheck ccache doctest-dev \

        pip3 install --user pytest

    - name: Setup paths
      shell: bash
      id: paths
      run: |
        mkdir -p build src install ccache
        echo ::set-output name=src::$(pwd)/src
        echo ::set-output name=build::$(pwd)/build
        echo ::set-output name=install::$(pwd)/install
        echo ::set-output name=ccache::$(pwd)/ccache

    - name: Get latest CMake and ninja
      uses: xlauko/get-cmake@main

    # TODO(Heno) temporary download cxx-common ports
    - name: Clone the cxx-common ports
      id: cxx-common-ports
      uses: actions/checkout@v3
      with:
        repository: 'lifting-bits/cxx-common'
        path: ${{ steps.paths.outputs.src }}/cxx-common-ports
        ref: 'port-files'
        fetch-depth: 1

    - name: Clone the vcpkg for cxx-common
      id: cxx-common-ports-vcpkg
      uses: actions/checkout@v3
      with:
        repository: 'microsoft/vcpkg'
        path: ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg
        fetch-depth: 1

    - name: Setup vcpkg
      working-directory: ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg
      run: |
        export CMAKE_C_COMPILER_LAUNCHER="$(which ccache)"
        export CMAKE_CXX_COMPILER_LAUNCHER="$(which ccache)"

        ./bootstrap-vcpkg.sh
        ./vcpkg integrate install

    # setup cxx-common
    - name: Download cxx-common
      id: cxxcommon
      uses: lifting-bits/download-cxx-common@v1
      with:
        llvm: ${{ matrix.llvm }}
        version: ${{ matrix.cxxcommon_version }}
        token: ${{ secrets.GITHUB_TOKEN }}
        image: ${{ matrix.image.name }}
        image_tag: ${{ matrix.image.tag }}
        destination: ${{ steps.paths.outputs.install }}

    # setup circuitous
    - name: Clone the circuitous repository
      uses: actions/checkout@v3
      with:
        path: ${{ steps.paths.outputs.src }}/circuitous
        submodules: true
        fetch-depth: 1

    - name: Configure circuitous
      working-directory: ${{ steps.paths.outputs.src }}/circuitous
      env:
        # TODO(Heno): use ports from cxx-common
        VCPKG_ROOT: ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg
        CXX_COMMON_ROOT: ${{ steps.paths.outputs.src }}/cxx-common-ports
        CMAKE_PREFIX_PATH: ${{ steps.paths.outputs.install }}/vcpkg_ubuntu-20.04_llvm-14_amd64/installed/x64-linux-rel/share/:${CMAKE_PREFIX_PATH}
        BUILD_DIR: ${{ steps.paths.outputs.build }}/circuitous/
      shell: bash
      run: |
        # TODO(Heno): fix in port patch
        mkdir -p ./vcpkg_installed/x64-linux-rel
        mkdir -p ${{ steps.paths.outputs.src }}/cxx-common-ports/vcpkg/installed/x64-linux-rel
        cmake --preset ninja-cxx-common-system-llvm-x64-linux-rel -B ${{ steps.paths.outputs.build }}/circuitous

    - name: Configure debug
      working-directory: ${{ steps.paths.outputs.src }}/circuitous
      if: always()
      run: |
        cat  /home/runner/work/circuitous/circuitous/src/cxx-common-ports/vcpkg/buildtrees/remill/install-x64-linux-rel-rel-out.log

    - name: Build circuitous
      working-directory: ${{ steps.paths.outputs.build }}/circuitous
      env:
        CCACHE_DIR: ${{ steps.paths.outputs.ccache }}
      run: |
        cmake --build ${{ steps.paths.outputs.build }}/circuitous -j $(nproc)

    - name: Install circuitous
      working-directory: ${{ steps.paths.outputs.build }}/circuitous
      env:
        CCACHE_DIR: ${{ steps.paths.outputs.ccache }}
      run: |
        cmake --build ${{ steps.paths.outputs.build }}/circuitous --target install

    - name: Run circuitous unittests
      working-directory: ${{ steps.paths.outputs.build }}/circuitous
      run: |
        ctest --output-on-failure

    - name: Package circuitous
      working-directory: ${{ steps.paths.outputs.build }}/circuitous
      run: |
        cpack -G TXZ --config ./CPackConfig.cmake

    - name: Upload circuitous package artifact
      uses: actions/upload-artifact@v3
      with:
        name: circuitous-${{ matrix.image.name }}-${{ matrix.image.tag }}
        path: ${{ steps.paths.outputs.build }}/circuitous/package/
        retention-days: 30

  pre-release:
      if: success() && github.ref == 'refs/heads/master'
      name: "Pre Release"
      runs-on: ubuntu-20.04
      needs: build_linux

      steps:
      - name: Clone the vast repository
        uses: actions/checkout@v3
        with:
          path: ./circuitous
          fetch-depth: 1

      - name: "Download build artifacts"
        id: download
        uses: actions/download-artifact@v3

      - name: "Publish Pre-Release"
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"
          prerelease: true
          title: "Development Build"
          files: |
            ./circuitous/LICENSE
            ${{steps.download.outputs.download-path}}/circuitous-*/*.tar.xz
